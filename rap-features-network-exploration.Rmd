---
title: "Hip Hop Feature Network Exploration"
author: "David J. Barney"
date: "1/26/2019"
output: html_document
---

# Exploration and API Testing
## Data Wrangling
### Interacting with the Genius & Spotify APIs
First, install `geniusr` and `spotifyr` packages. You'll need to get a "client access token" from Genius [here](https://genius.com/api-clients) and from Spotify [here](https://developer.spotify.com/) and then assign it to your R environment with the `geniusr::genius_token()` function.

```{r setup, eval=FALSE}
#install.packages("geniusr")
#install.packages("spotifyr")
```

Now we can search the Genius API for songs and their metadata. 

### Reading in r/HHH Essentials lists

```{r Reading in r/HHH Essentials lists, eval=FALSE, include=FALSE}
library(tidyverse)
#library(tidytext)
#library(geniusr)
library(spotifyr)

## ALTERNATE DATA - Read in the regional essentials
# hhh_east <- read_csv("./r_hiphopheads_Essentials_List_East.csv")
# hhh_west <- read_csv("./r_hiphopheads_Essentials_List_West.csv")
# hhh_south <- read_csv("./r_hiphopheads_Essentials_List_South.csv")
# hhh_midwest <- read_csv("./r_hiphopheads_Essentials_List_Midwest.csv")

# Combine into one dataframe
#hhhe <- rbind(hhh_east,hhh_west,hhh_south,hhh_midwest)

# Select the artist and album vectors
#hhhe <- select(hhhe,artist_name:album_title)

head(hhhe)
```

### Search Genius API for HHH Essentials

```{r Genius - search artists, eval=FALSE, include=FALSE}
kanye_search <- search_artist(search_term = "Kanye")
kanye_search <- slice(kanye_search,1)
kanye_search <- select(kanye_search,1:2)
head(kanye_search)
```

```{r Genius - search songs, eval=FALSE, include=FALSE}
# Clear last test
jesuswalks_search <- search_song(search_term = "Jesus Walks")
jesuswalks_search <- slice(jesuswalks_search,1)
jesuswalks_search <- select(jesuswalks_search,1:2)
head(jesuswalks_search)
```

```{r Genius - search an artist's songs filtered by album, eval=FALSE, include=FALSE}
kanye_songs <- get_artist_songs(artist_id = kanye_search[[1]])
head(kanye_songs)
```

```{r Genius - pull metadata for one song, eval=FALSE, include=FALSE}
jesuswalks_meta <- get_song_meta(song_id = 519)
head(jesuswalks_meta)
```

```{r Genius - pull tracklist for one album, eval=FALSE, include=FALSE}
college_dropout <- scrape_tracklist(album_id = 111578)
head(college_dropout)
```



### Search Spotify API for HHH Essentials
```{r Spotify - search artists, eval=FALSE, include=FALSE}
mac_miller_search <- get_artists('mac miller') %>%
  slice(.,1) %>%
  select(.,1:2)

```

```{r Spotify - search albums, eval=FALSE, include=FALSE}
mac_miller_album_search <- get_albums(mac_miller_search$artist_uri)

```

```{r Spotify - pull tracklists, eval=FALSE, include=FALSE}
mac_miller_tracks <- get_album_tracks(mac_miller_album_search)
```

### Regex to identify features in track names

```{r Regex setup, eval=FALSE, include=FALSE}
library(stringr)
library(tidyr)

# Define the features conjunctions
featuring <- c("feat\\.","ft\\.", "feat", "ft", "featuring")
ft_match <- str_c(featuring, collapse = "|")

multiple_fts <- c(",","&","[[:space:]]+and[[:space:]]+")
m_fts_match <- str_c(multiple_fts, collapse = "|")

#brackets <- c(".\\(.",".\\).",".\\[.",".\\].")
#brackets_match <- str_c(brackets, collapse = "|")
brackets <- c("\\[$","\\]$")
brackets_match <- str_c(brackets, collapse = "|")

# All to lowercase
mac_miller_tracks$track_name <- str_to_lower(mac_miller_tracks$track_name) 

# Working with the "tracks" dataframe
mac_miller_tracks_w_feats <- mac_miller_tracks 
mac_miller_tracks_w_feats$artist <- "mac miller"

mac_miller_tracks_w_feats <- mac_miller_tracks_w_feats %>%
  dplyr::filter(str_detect(mac_miller_tracks_w_feats$track_name, "feat\\.")) %>%
  select(track_name, artist) %>%
  separate(track_name, c("track", "feature"), "feat\\.") %>%
  mutate(feature_list = str_split(feature, m_fts_match, n = Inf)) %>%
  unnest(feature_list)

mac_miller_tracks_w_feats$feature_list <- mac_miller_tracks_w_feats$feature_list %>%
  str_replace_all("\\)","") %>%
  str_replace_all("\\]","")

```

# Working Method
## Iterative calls to the Spotify API
```{r Get artists}
# Read in the cleaned overposted list
hhhe <- read_csv("r_hiphopheads_overposted.csv")

# Get character vectors of the unique artists & albums
artists <- unique(hhhe$Artist)
albumnames <- unique(hhhe$Album)

# Get Spotify artist uri identifiers
artists_df <- map_dfr(artists, get_artists) %>%
  filter(artist_name %in% artists) %>%
  select(artist_name, artist_uri)

write.csv(artists_df, file = "all_artists.csv")

head(artists_df)
```

```{r Get albums}
#artist_ids <- artists_df$artist_uri

# Get Spotify album identifiers for all these artists
album_list <- list()

for (i in 1:nrow(artists_df)){
  temp <- get_albums(artists_df$artist_uri[[i]])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  temp$artist <- artists_df$artist_name[[i]]
  album_list[[i]] <- temp
}

all_albums <- do.call(rbind, album_list)

write.csv(all_albums, file = "all_albums.csv")

head(all_albums)
```

```{r Get album tracks}
tracks_list <- list()

for (i in 1:nrow(all_albums)){
  temp <- get_album_tracks(all_albums[i,])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  temp$artist <- all_albums$artist[i]
  tracks_list[[i]] <- temp
}

all_tracks <- do.call(rbind, tracks_list)


#all_tracks <- rbind(tracks_1,tracks_2,tracks_3,tracks_4,tracks_5,tracks_6,tracks_7)

write.csv(all_tracks, file = "all_tracks.csv")

head(all_tracks)
rm(all_tracks)
```

## Data Wrangling
```{r Read in aggregate tracklist}
library(tidyverse)
library(spotifyr)
library(stringi)
library(igraph)
all_tracks <- read.csv("all_tracks.csv")
all_tracks[sample(nrow(all_tracks), 5), ]
```


```{r Define regex patterns for wrangling}
# Define the features conjunctions
featuring <- c("featuring", "feat\\.","ft\\.", "feat", "ft")
ft_match <- str_c(featuring, collapse = "|")

# Patterns for multiple features
multiple_fts <- c(",","&","[[:space:]]+and[[:space:]]+")
m_fts_match <- str_c(multiple_fts, collapse = "|")

# Punctuation for cleaning
punctuation <- c("\\[","]","\\(","\\)","/","-")
punc_match <- str_c(punctuation, collapse = "|")
```

```{r Wrangle tracklistings into initial edge list}
## Tidy and clean tracks dataframe
all_tracks_w_feats <- all_tracks

# All to lowercase
all_tracks_w_feats$track_name <- str_to_lower(all_tracks_w_feats$track_name)
all_tracks_w_feats$artist <- str_to_lower(all_tracks_w_feats$artist)

# Split strings at feature pattern into new column
all_tracks_w_feats <- all_tracks_w_feats %>%
  dplyr::filter(str_detect(all_tracks_w_feats$track_name, ft_match)) %>%
  select(track_name, artist) %>%
  separate(track_name, c("track", "feature"), ft_match) %>%
  mutate(feature_list = str_split(feature, m_fts_match, n = Inf)) %>%
  unnest(feature_list)

# Clean out punctuation and whitespace
all_tracks_w_feats$feature_list <- all_tracks_w_feats$feature_list %>%
  str_replace_all(punc_match,"") %>%
  str_trim(side = "both") %>%
  str_squish()

# Some custom cleaning  
all_tracks_w_feats$feature_list <- gsub("2014.","",all_tracks_w_feats$feature_list)
all_tracks_w_feats$feature_list <- gsub("explicit.","",all_tracks_w_feats$feature_list)
all_tracks_w_feats$feature_list <- gsub("album.","",all_tracks_w_feats$feature_list)

## Filter out entities with only 1 occurence
# Count occurences in artists vector
artist_count <- all_tracks_w_feats %>%
  group_by(artist) %>%
  summarise(artist_count = n()) %>%
  rename(entity = artist) %>%
  ungroup()

# Count occurences in feature_list vector
feature_list_count <- all_tracks_w_feats %>%
  group_by(feature_list) %>%
  summarise(feature_list_count = n()) %>%
  rename(entity = feature_list) %>%
  ungroup()

# Aggregate occurences
entity_counts <- full_join(artist_count, 
                           feature_list_count,
                           by = "entity")

entity_counts <- entity_counts %>%
  rowwise() %>%
  mutate(total_counts = sum(artist_count,feature_list_count, na.rm = TRUE))

entity_counts <- entity_counts %>%
  select(entity, total_counts) %>%
  filter(total_counts >= 2)

# Filter final dataframe based on counts
all_tracks_w_feats <- all_tracks_w_feats %>%
  filter(artist %in% entity_counts$entity | feature_list %in% entity_counts$entity )

# Edge list
edge_list <- all_tracks_w_feats %>%
  select(artist, feature_list)

edge_list[sample(nrow(edge_list), 5), ]
``` 

```{r Create a nodes list}
# Isolate artists and features
artists <- edge_list %>%
  distinct(artist) %>% 
  rename(label = artist)

artists <- artists[[1]]

features <- edge_list %>%
  distinct(feature_list) %>% 
  rename(label = feature_list)

features <- features[[1]]

entities <- c(artists,features)

entities <- stri_unique(entities)

# Aggregate all entities
nodes <- bind_rows(artists,features) %>%
  rowid_to_column("id")

#Remove duplicate entities
# entity_vec <- as.character(nodes$label)
# 
# for (i in 1:length(entity_vec)){
#   dupe_search <- paste0("^",entity_vec[i])
#   temp_chr <- grep(dupe_search, nodes$label, value = TRUE)
#   temp_ind <- grep(dupe_search, nodes$label, value = FALSE)
#   if (length(temp_ind) > 1){
#     print(temp_chr)
#     # for (j in 2:length(temp_ind)){
#     #   
#     # }
#   }
# }
# 
nodes[sample(nrow(nodes), 5), ]
```


```{r Add frequency weights to the edge list}
weighted_edge_list <- edge_list %>%
  group_by(artist,featured) %>%
  summarise(weight = n()) %>%
  ungroup()

head(weighted_edge_list)
```

```{r Merge edge and node lists}
# edges <- weighted_edge_list %>%
  # rename(artist_chr = artist) %>%
  # rename(featured_chr = featured) %>%
#   mutate(artist = artist_chr %in% nodes$)

edges <- weighted_edge_list %>%
  rename(artist_chr = artist) %>%
  rename(featured_chr = featured)

edges <- edges %>% 
  left_join(nodes, by = c("artist_chr" = "label")) %>%
  rename(artist = id)

edges <- edges %>%
  left_join(nodes, by = c("featured_chr" = "label")) %>%
  rename(featured = id)

```

