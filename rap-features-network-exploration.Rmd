---
title: "Hip Hop Feature Network Exploration"
author: "David J. Barney"
date: "1/26/2019"
output: html_document
---

# Data Wrangling
## Interacting with the Genius & Spotify APIs
First, install `geniusr` and `spotifyr` packages. You'll need to get a "client access token" from Genius [here](https://genius.com/api-clients) and from Spotify [here](https://developer.spotify.com/) and then assign it to your R environment with the `geniusr::genius_token()` function.

```{r setup, eval=FALSE}
#install.packages("geniusr")
#install.packages("spotifyr")
```

Now we can search the Genius API for songs and their metadata. 

## Reading in r/HHH Essentials lists

```{r Reading in r/HHH Essentials lists}
library(tidyverse)
#library(tidytext)
#library(geniusr)
library(spotifyr)

# Read in the regional essentials
# I've already cleaned these for easy aggregation
hhh_east <- read_csv("./r_hiphopheads_Essentials_List_East.csv")
hhh_west <- read_csv("./r_hiphopheads_Essentials_List_West.csv")
hhh_south <- read_csv("./r_hiphopheads_Essentials_List_South.csv")
hhh_midwest <- read_csv("./r_hiphopheads_Essentials_List_Midwest.csv")

# Combine into one dataframe
hhhe <- rbind(hhh_east,hhh_west,hhh_south,hhh_midwest)

# Select the artist and album vectors
hhhe <- select(hhhe,artist_name:album_title)

head(hhhe)
```

## Search Genius API for HHH Essentials

```{r Genius - search artists, eval=FALSE, include=FALSE}
kanye_search <- search_artist(search_term = "Kanye")
kanye_search <- slice(kanye_search,1)
kanye_search <- select(kanye_search,1:2)
head(kanye_search)
```

```{r Genius - search songs, eval=FALSE, include=FALSE}
# Clear last test
jesuswalks_search <- search_song(search_term = "Jesus Walks")
jesuswalks_search <- slice(jesuswalks_search,1)
jesuswalks_search <- select(jesuswalks_search,1:2)
head(jesuswalks_search)
```

```{r Genius - search an artist's songs filtered by album, eval=FALSE, include=FALSE}
kanye_songs <- get_artist_songs(artist_id = kanye_search[[1]])
head(kanye_songs)
```

```{r Genius - pull metadata for one song, eval=FALSE, include=FALSE}
jesuswalks_meta <- get_song_meta(song_id = 519)
head(jesuswalks_meta)
```

```{r Genius - pull tracklist for one album, eval=FALSE, include=FALSE}
college_dropout <- scrape_tracklist(album_id = 111578)
head(college_dropout)
```


## Search Spotify API for HHH Essentials
```{r Spotify - search artists}
mac_miller_search <- get_artists('mac miller') %>%
  slice(.,1) %>%
  select(.,1:2)

```

```{r Spotify - search albums}
mac_miller_album_search <- get_albums(mac_miller_search$artist_uri)

```

```{r Spotify - pull tracklists}
mac_miller_tracks <- get_album_tracks(mac_miller_album_search)
```

## Regex to identify features in track names

```{r Regex setup}
library(stringr)
library(tidyr)

# Define the features conjunctions
featuring <- c("feat\\.","ft\\.", "feat", "ft", "featuring")
ft_match <- str_c(featuring, collapse = "|")

multiple_fts <- c(",","&","[[:space:]]+and[[:space:]]+")
m_fts_match <- str_c(multiple_fts, collapse = "|")

#brackets <- c(".\\(.",".\\).",".\\[.",".\\].")
#brackets_match <- str_c(brackets, collapse = "|")
brackets <- c("\\[$","\\]$")
brackets_match <- str_c(brackets, collapse = "|")

# All to lowercase
mac_miller_tracks$track_name <- str_to_lower(mac_miller_tracks$track_name) 

# Working with the "tracks" dataframe
mac_miller_tracks_w_feats <- mac_miller_tracks 
mac_miller_tracks_w_feats$artist <- "mac miller"

mac_miller_tracks_w_feats <- mac_miller_tracks_w_feats %>%
  dplyr::filter(str_detect(mac_miller_tracks_w_feats$track_name, "feat\\.")) %>%
  select(track_name, artist) %>%
  separate(track_name, c("track", "feature"), "feat\\.") %>%
  mutate(feature_list = str_split(feature, m_fts_match, n = Inf)) %>%
  unnest(feature_list)

mac_miller_tracks_w_feats$feature_list <- mac_miller_tracks_w_feats$feature_list %>%
  str_replace_all("\\)","") %>%
  str_replace_all("\\]","")

```


# Iterative calls to the Spotify API
```{r Get artists}
# Read in the cleaned overposted list
hhhe <- read_csv("r_hiphopheads_overposted.csv")

# Get character vectors of the unique artists & albums
artists <- unique(hhhe$Artist)
albumnames <- unique(hhhe$Album)

# Get Spotify artist uri identifiers
artists_df <- map_dfr(artists, get_artists) %>%
  filter(artist_name %in% artists) %>%
  select(artist_name, artist_uri)

write.csv(artists_df, file = "all_artists.csv")

head(artists_df)
```

```{r Get albums}
artist_ids <- artists_df$artist_uri

# Get Spotify album identifiers for all these artists
album_list <- list()

for (i in 1:length(artist_ids)){
  temp <- get_albums(artist_ids[[i]])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  album_list[[i]] <- temp
}

all_albums <- do.call(rbind, album_list)

write.csv(all_albums, file = "all_albums.csv")

head(all_albums)
```

```{r Get album tracks}
all_albums_1 <- all_albums[1:100,]
all_albums_2 <- all_albums[101:200,]
all_albums_3 <- all_albums[201:300,]
all_albums_4 <- all_albums[301:400,]
all_albums_5 <- all_albums[401:500,]
all_albums_6 <- all_albums[501:600,]
all_albums_7 <- all_albums[601:636,]


tracks_1 <- get_album_tracks(all_albums_1)
tracks_2 <- get_album_tracks(all_albums_2)
tracks_3 <- get_album_tracks(all_albums_3)
tracks_4 <- get_album_tracks(all_albums_4)
tracks_5 <- get_album_tracks(all_albums_5)
tracks_6 <- get_album_tracks(all_albums_6)
tracks_7 <- get_album_tracks(all_albums_7)

all_tracks <- rbind(tracks_1,tracks_2,tracks_3,tracks_4,tracks_5,tracks_6,tracks_7)

write.csv(all_tracks, file = "all_tracks.csv")

head(all_tracks)

```


```{r Turn all tracks into an edge list}
# All to lowercase
all_tracks$track_name <- str_to_lower(all_tracks$track_name) 

# Working with the "tracks" dataframe
all_tracks_w_feats <- all_tracks


# RESUME BELOW
# Need to find a way to merge the main artist name back into this df
mac_miller_tracks_w_feats$artist <- "mac miller"

mac_miller_tracks_w_feats <- mac_miller_tracks_w_feats %>%
  dplyr::filter(str_detect(mac_miller_tracks_w_feats$track_name, "feat\\.")) %>%
  select(track_name, artist) %>%
  separate(track_name, c("track", "feature"), "feat\\.") %>%
  mutate(feature_list = str_split(feature, m_fts_match, n = Inf)) %>%
  unnest(feature_list)

mac_miller_tracks_w_feats$feature_list <- mac_miller_tracks_w_feats$feature_list %>%
  str_replace_all("\\)","") %>%
  str_replace_all("\\]","")

```

