---
title: "Hip Hop Feature Network Exploration"
author: "David J. Barney"
date: "1/26/2019"
output: html_document
---

# Exploration and API Testing
## Data Wrangling
### Interacting with the Genius & Spotify APIs
First, install `geniusr` and `spotifyr` packages. You'll need to get a "client access token" from Genius [here](https://genius.com/api-clients) and from Spotify [here](https://developer.spotify.com/) and then assign it to your R environment with the `geniusr::genius_token()` function.

```{r setup, eval=FALSE}
#install.packages("geniusr")
#install.packages("spotifyr")
```

Now we can search the Genius API for songs and their metadata. 

### Reading in r/HHH Essentials lists

```{r Reading in r/HHH Essentials lists, eval=FALSE, include=FALSE}
library(tidyverse)
#library(tidytext)
#library(geniusr)
library(spotifyr)

## ALTERNATE DATA - Read in the regional essentials
# hhh_east <- read_csv("./r_hiphopheads_Essentials_List_East.csv")
# hhh_west <- read_csv("./r_hiphopheads_Essentials_List_West.csv")
# hhh_south <- read_csv("./r_hiphopheads_Essentials_List_South.csv")
# hhh_midwest <- read_csv("./r_hiphopheads_Essentials_List_Midwest.csv")

# Combine into one dataframe
#hhhe <- rbind(hhh_east,hhh_west,hhh_south,hhh_midwest)

# Select the artist and album vectors
#hhhe <- select(hhhe,artist_name:album_title)

head(hhhe)
```

### Search Genius API for HHH Essentials

```{r Genius - search artists, eval=FALSE, include=FALSE}
kanye_search <- search_artist(search_term = "Kanye")
kanye_search <- slice(kanye_search,1)
kanye_search <- select(kanye_search,1:2)
head(kanye_search)
```

```{r Genius - search songs, eval=FALSE, include=FALSE}
# Clear last test
jesuswalks_search <- search_song(search_term = "Jesus Walks")
jesuswalks_search <- slice(jesuswalks_search,1)
jesuswalks_search <- select(jesuswalks_search,1:2)
head(jesuswalks_search)
```

```{r Genius - search an artist's songs filtered by album, eval=FALSE, include=FALSE}
kanye_songs <- get_artist_songs(artist_id = kanye_search[[1]])
head(kanye_songs)
```

```{r Genius - pull metadata for one song, eval=FALSE, include=FALSE}
jesuswalks_meta <- get_song_meta(song_id = 519)
head(jesuswalks_meta)
```

```{r Genius - pull tracklist for one album, eval=FALSE, include=FALSE}
college_dropout <- scrape_tracklist(album_id = 111578)
head(college_dropout)
```



### Search Spotify API for HHH Essentials
```{r Spotify - search artists, eval=FALSE, include=FALSE}
mac_miller_search <- get_artists('mac miller') %>%
  slice(.,1) %>%
  select(.,1:2)

```

```{r Spotify - search albums, eval=FALSE, include=FALSE}
mac_miller_album_search <- get_albums(mac_miller_search$artist_uri)

```

```{r Spotify - pull tracklists, eval=FALSE, include=FALSE}
mac_miller_tracks <- get_album_tracks(mac_miller_album_search)
```

### Regex to identify features in track names

```{r Regex setup, eval=FALSE, include=FALSE}
library(stringr)
library(tidyr)

# Define the features conjunctions
featuring <- c("feat\\.","ft\\.", "feat", "ft", "featuring")
ft_match <- str_c(featuring, collapse = "|")

multiple_fts <- c(",","&","[[:space:]]+and[[:space:]]+")
m_fts_match <- str_c(multiple_fts, collapse = "|")

#brackets <- c(".\\(.",".\\).",".\\[.",".\\].")
#brackets_match <- str_c(brackets, collapse = "|")
brackets <- c("\\[$","\\]$")
brackets_match <- str_c(brackets, collapse = "|")

# All to lowercase
mac_miller_tracks$track_name <- str_to_lower(mac_miller_tracks$track_name) 

# Working with the "tracks" dataframe
mac_miller_tracks_w_feats <- mac_miller_tracks 
mac_miller_tracks_w_feats$artist <- "mac miller"

mac_miller_tracks_w_feats <- mac_miller_tracks_w_feats %>%
  dplyr::filter(str_detect(mac_miller_tracks_w_feats$track_name, "feat\\.")) %>%
  select(track_name, artist) %>%
  separate(track_name, c("track", "feature"), "feat\\.") %>%
  mutate(feature_list = str_split(feature, m_fts_match, n = Inf)) %>%
  unnest(feature_list)

mac_miller_tracks_w_feats$feature_list <- mac_miller_tracks_w_feats$feature_list %>%
  str_replace_all("\\)","") %>%
  str_replace_all("\\]","")

```

# Working Method
## Iterative calls to the Spotify API
```{r Get artists}
# Read in the cleaned overposted list
hhhe <- read_csv("r_hiphopheads_overposted.csv")

# Get character vectors of the unique artists & albums
artists <- unique(hhhe$Artist)
albumnames <- unique(hhhe$Album)

# Get Spotify artist uri identifiers
artists_df <- map_dfr(artists, get_artists) %>%
  filter(artist_name %in% artists) %>%
  select(artist_name, artist_uri)

write.csv(artists_df, file = "all_artists.csv")

head(artists_df)
```

```{r Get albums}
#artist_ids <- artists_df$artist_uri

# Get Spotify album identifiers for all these artists
album_list <- list()

for (i in 1:nrow(artists_df)){
  temp <- get_albums(artists_df$artist_uri[[i]])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  temp$artist <- artists_df$artist_name[[i]]
  album_list[[i]] <- temp
}

all_albums <- do.call(rbind, album_list)

write.csv(all_albums, file = "all_albums.csv")

head(all_albums)
```

```{r Get album tracks}
tracks_list <- list()

for (i in 1:nrow(all_albums)){
  temp <- get_album_tracks(all_albums[i,])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  temp$artist <- all_albums$artist[i]
  tracks_list[[i]] <- temp
}

all_tracks <- do.call(rbind, tracks_list)


#all_tracks <- rbind(tracks_1,tracks_2,tracks_3,tracks_4,tracks_5,tracks_6,tracks_7)

write.csv(all_tracks, file = "all_tracks.csv")

head(all_tracks)
rm(all_tracks)
```

## Data Wrangling
```{r Read in aggregate tracklist}
library(tidyverse)
library(spotifyr)
library(stringi)
all_tracks <- read.csv("all_tracks.csv")
head(all_tracks)
```


```{r Define regex patterns for wrangling}
# Define the features conjunctions
featuring <- c("feat\\.","ft\\.", "feat", "ft", "featuring")
ft_match <- str_c(featuring, collapse = "|")

multiple_fts <- c(",","&","[[:space:]]+and[[:space:]]+")
m_fts_match <- str_c(multiple_fts, collapse = "|")

#brackets <- c(".\\(.",".\\).",".\\[.",".\\].")
#brackets_match <- str_c(brackets, collapse = "|")
brackets <- c("\\[$","\\]$")
brackets_match <- str_c(brackets, collapse = "|")
```

```{r Wrangle into an initial edge list}
# All to lowercase
all_tracks$track_name <- str_to_lower(all_tracks$track_name)
all_tracks$artist <- str_to_lower(all_tracks$artist)
all_tracks$artist <- trimws(all_tracks$artist, which = "both")
all_tracks$track_name <- trimws(all_tracks$track_name, which = "both")

# Working with the "tracks" dataframe
all_tracks_w_feats <- all_tracks

all_tracks_w_feats <- all_tracks_w_feats %>%
  dplyr::filter(str_detect(all_tracks_w_feats$track_name, "feat\\.")) %>%
  select(track_name, artist) %>%
  separate(track_name, c("track", "feature"), "feat\\.") %>%
  mutate(feature_list = str_split(feature, m_fts_match, n = Inf)) %>%
  unnest(feature_list)

all_tracks_w_feats$feature_list <- all_tracks_w_feats$feature_list %>%
  str_replace_all("[^[:alnum:][:space:]]","")
  # str_replace_all("\\)","") %>%
  # str_replace_all("\\]","") #%>%
  # #str_replace_all("\\(","") %>%


edge_list <- all_tracks_w_feats %>%
  select(artist, feature_list) %>%
  rename(featured = feature_list)

head(edge_list)
```

```{r Add frequency weights to the edge list}
weighted_edge_list <- edge_list %>%
  group_by(artist,featured) %>%
  summarise(weight = n()) %>%
  ungroup()

head(weighted_edge_list)
```

```{r Create a nodes list}
# Isolate artists and features
artists <- weighted_edge_list %>%
  distinct(artist) %>% 
  rename(label = artist) %>%
  as.tibble()

features <- weighted_edge_list %>%
  distinct(featured) %>% 
  rename(label = featured) %>%
  as.tibble()


# Bring it all together
nodes <- bind_rows(artists,features) %>% 
  rowid_to_column("id")

#Remove duplicate entities
entity_dupes <- c()

for (i in 1:nrow(nodes)){
  dupe_search <- paste(nodes[i,2])
  temp <- grep(dupe_search, nodes$label, value = TRUE)
  if (length(temp) > 1){
    #entity_dupes <- c(entity_dupes, temp[-1])
    print(temp)
  }
  # entity_dupes[[i]] <- temp
}

entity_dupes <- unique(entity_dupes)

# nodes <- nodes %>%
#   distinct(label)

nodes_test <- nodes %>%
  distinct_at(label)



# %>%
#   rowid_to_column("id") %>%
#   distinct(label)

head(nodes)
```

```{r Merge edge and node lists}
# edges <- weighted_edge_list %>%
  # rename(artist_chr = artist) %>%
  # rename(featured_chr = featured) %>%
#   mutate(artist = artist_chr %in% nodes$)

edges <- weighted_edge_list %>%
  rename(artist_chr = artist) %>%
  rename(featured_chr = featured)

edges <- edges %>% 
  left_join(nodes, by = c("artist_chr" = "label")) %>%
  rename(artist = id)

edges <- edges %>%
  left_join(nodes, by = c("featured_chr" = "label")) %>%
  rename(featured = id)

```

