---
title: "Rap Feature Network - Data Pipeline"
author: "David J. Barney"
date: "1/26/2019"
output: html_document
---

# Setup
First, set the working directory to the `../2_scripts/` subfolder of this repository to keep things organized.

Next, install and source the `spotifyr` package. You'll need to get a "client access token" from Spotify [here](https://developer.spotify.com/) and pass it through the `spotifyr::get_spotify_access_token()` function. Additional instructions from the package developer can be found [here](https://github.com/charlie86/spotifyr). 

In addition, we'll be using the `tidyverse` and `stringi` packages, so be sure to install and source those as well. Lastly, we need to source `query_flat.R`, which contains helper functions for data pulls with `spotifyr`.

```{r Load libraries}
## Libraries
#install.packages("spotifyr")
library(spotifyr)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("stringi")
library(stringi)

## Helper scripts
source("../2_scripts/query_flat.R")
```

Now we can search the Spotify API for artists, albums, songs, their metadata, etc. 

# Data Pipeline
Now we're ready to pull data from Spotify. To keep things reasonable, we'll scrape the discography tracklists for all artists that appear in the ["Overposted Albums" list](https://docs.google.com/spreadsheets/d/1Qpbd-fHbMyfWXlWPRA_XfgzYayc8cIjn8J9CuL-aNpE/edit#gid=0) from the [r/hiphopheads](https://www.reddit.com/r/hiphopheads/) subreddit. 

**Note**: `../1_data/r_hiphopheads_overposted.csv` was pulled on 2019-03-31, and is likely to have been updated since.

## Initial Artist List
```{r Load data, eval=TRUE}
hhhe <- read_csv("../1_data/Reddit/r_hiphopheads_overposted.csv")
hhhe_artists <- unique(hhhe$Artist)
```

```{r Get Spotify artist data, eval=TRUE}
artists_df <- query_artists_flat(hhhe_artists)

artists_df <- artists_df %>%
  rename(artist_uri = id, artist_name = name, artist_followers = followers.total) %>%
  select(artist_name, artist_uri, genres, artist_followers) %>%
  mutate(genres = as.character(genres))
  
artists_df$artist_name <- str_remove(string = artists_df$artist_name, pattern = ",")

write_csv(artists_df, "../1_data/Spotify/artists.csv")
```

```{r Get Spotify album IDs, eval=TRUE}
# Get Spotify album identifiers for all these artists
#artists_df <- read_csv("../1_data/Spotify/artists.csv")

albums_df <- query_albums_flat(artists_df$artist_uri)

albums_df <- albums_df %>%
  distinct(name, .keep_all = TRUE) %>%
  select(id, name, artist, release_date, type) %>%
  rename(album_uri = id, album_name = name, album_type = type)

albums_df$artist <- str_replace(string = albums_df$artist, pattern = "Tyler, The Creator", replacement = "Tyler The Creator")

write_csv(albums_df, "../1_data/Spotify/albums.csv")
```

```{r Get tracks, eval=TRUE}
tracks_df <- query_tracks_flat(albums_df$album_uri, albums_df$album_name)

tracks_df <- tracks_df %>%
  rename(track_uri = id, track_name = name) %>%
  select(track_artists, album_name, track_uri, track_name, track_popularity)

tracks_df$track_artists <- str_replace(string = tracks_df$track_artists, 
                                       pattern = "Tyler, The Creator", 
                                       replacement = "Tyler The Creator")

write_csv(tracks_df, "../1_data/Spotify/tracks.csv")
```

```{r Clear Environment, eval=FALSE}
rm(list=ls())
```

## Extended Artist List
```{r Load data from initial queries}
artists_df <- read_csv("../1_data/Spotify/artists.csv")
albums_df <- read_csv("../1_data/Spotify/albums.csv")
tracks_df <- read_csv("../1_data/Spotify/tracks.csv")
```


```{r All featured artists not appearing in initial dataset}
tracks_df <- read_csv("../1_data/Spotify/tracks.csv")
extended_artists <- tracks_df$track_artists %>%
  str_split(", ") %>%
  unlist() %>%
  unique() %>%
  str_remove(pattern = paste(hhhe_artists, collapse = "|"))
extended_artists <- extended_artists[extended_artists != ""]
```

```{r Get Spotify artist data, eval=FALSE}
artists_df_2 <- query_artists_flat(extended_artists)

artists_df_2 <- artists_df_2 %>%
  rename(artist_uri = id, artist_name = name, artist_followers = followers.total) %>%
  select(artist_name, artist_uri, genres, artist_followers) %>%
  mutate(genres = as.character(genres)) 

artists_df_2$genres <- str_remove(string = artists_df_2$genres, pattern = "character(0)")
artists_df_2$artist_name <- str_remove(string = artists_df_2$artist_name, pattern = ",")

#write_csv(artists_df, "../1_data/Spotify/artists.csv")
```


# Aggregate 

```{r Bind all data together, eval=TRUE}
artists_df <- read_csv("../1_data/Spotify/artists.csv")
albums_df <- read_csv("../1_data/Spotify/albums.csv")
tracks_df <- read_csv("../1_data/Spotify/tracks.csv")

tidy_tracks <- all_tracklists_with_features_nested %>%
  left_join(albums_df, by = "album_name") %>%
  left_join(artists_df, by = "artist_name")

write_csv(tidy_tracks, "../1_data/tidy_tracks.csv")

# tracks_df <- tracks_df %>%
#   group_by(artist_name) %>%
#   distinct(track_name, .keep_all = TRUE) %>%
#   ungroup()
```

# Reproducability
```{r}
print(sessionInfo())
```

