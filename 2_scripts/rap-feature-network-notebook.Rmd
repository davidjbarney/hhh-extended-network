---
title: "Rap Feature Network - Notebook"
author: "David J. Barney"
date: "1/26/2019"
output: html_document
---

# Setup
First, set the working directory to the `../2_scripts/` subfolder of this repository to keep things organized.

Next, install and source the `spotifyr` package. You'll need to get a "client access token" from Spotify [here](https://developer.spotify.com/) and pass it through the `spotifyr::get_spotify_access_token()` function. Additional instructions from the package developer can be found [here](https://github.com/charlie86/spotifyr). 

We'll also be using the `tidyverse`, `stringi`, `igraph`, and `viridis` packages, so be sure to install and source those as well.

```{r Load libraries}
#install.packages("spotifyr")
library(spotifyr)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("stringi")
library(stringi)
#install.packages("igraph")
library(igraph)
#install.packages("viridis")
library(viridis)
```

Now we can search the Spotify API for artists, albums, songs, their metadata, etc. 

# Data Pipeline
Now we're ready to pull data from Spotify. To keep things reasonable, we'll scrape the discography tracklists for all artists that appear in the ["Overposted Albums" list](https://docs.google.com/spreadsheets/d/1Qpbd-fHbMyfWXlWPRA_XfgzYayc8cIjn8J9CuL-aNpE/edit#gid=0) from the [r/hiphopheads](https://www.reddit.com/r/hiphopheads/) subreddit. 

**Note**: `../1_data/r_hiphopheads_overposted.csv` was pulled on 2019-03-31, and is likely to have been updated since.

## Query Spotify API
```{r Read in Reddit data, eval=FALSE}
hhhe <- read_csv("../1_data/Reddit/r_hiphopheads_overposted.csv")
hhhe[sample(nrow(hhhe), 5), ]
```

```{r Get Spotify artist IDs, eval=FALSE}
# Get character vectors of the unique artists & albums
artists <- unique(hhhe$Artist)
albumnames <- unique(hhhe$Album)

# Get Spotify artist uri identifiers
artists_df <- map_dfr(artists, search_spotify, type = "artist", limit = 1) %>%
  rename(artist_uri = id, artist_name = name) %>%
  filter(artist_name %in% artists) %>%
  select(artist_name, artist_uri)

write_csv(artists_df, "../1_data/Spotify/all_artists.csv")
```

To update below: remove duplicates (e.g. keep only "deluxe" version of an album)

```{r Get Spotify album IDs, eval=FALSE}
# Get Spotify album identifiers for all these artists
album_list <- list()

for(i in 1:nrow(artists_df)){
  temp <- get_artist_albums(artists_df$artist_uri[[i]], 
                            include_groups = "album", 
                            market = "US")
  Sys.sleep(3) # Pause to avoid breaking the API calls
  temp$artist <- artists_df$artist_name[[i]]
  album_list[[i]] <- temp
}

albums_df <- do.call(rbind, album_list)

albums_df <- albums_df %>%
  distinct(name, .keep_all = TRUE) %>%
  select(id, name, artist, release_date) %>%
  rename(album_uri = id, album_name = name)

write_csv(albums_df, "../1_data/Spotify/all_albums.csv")
```

```{r Get tracks, eval=FALSE}
tracklists_list <- list()

for (i in 1:nrow(albums_df)){
  temp <- get_album_tracks(albums_df$album_uri[i])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  temp$artist_name <- albums_df$artist[i]
  temp$album_name <- albums_df$album_name[i]
  tracklists_list[[i]] <- temp
}

all_tracklists <- do.call(rbind, tracklists_list)

all_tracklists <- all_tracklists %>%
  rename(track_uri = id, track_name = name) %>%
  select(artist_name, album_name, track_uri, track_name)

all_tracklists <- all_tracklists %>%
  group_by(artist_name) %>%
  distinct(track_name, .keep_all = TRUE) %>%
  ungroup()

write_csv(all_tracklists, "../1_data/Spotify/all_tracklists.csv")
```

```{r Get track data from tracklists, eval=FALSE}
all_tracklists <- read_csv("../1_data/Spotify/all_tracklists.csv")
all_tracklists$feature <- NA
all_tracklists$track_popularity <- NA

for (i in 1:nrow(all_tracklists)){
  metadata <- get_track(all_tracklists$track_uri[i])
  Sys.sleep(1) # Pause to avoid breaking the API calls
  temp_feats <- metadata[[2]][["name"]]
  if (length(temp_feats) > 1){
    all_tracklists$feature[i] <- list(temp_feats[-1])
  }
  all_tracklists$track_popularity <- metadata[["popularity"]]
}

all_tracklists_with_features_nested <- all_tracklists %>%
  mutate(feature = map_chr(feature, toString))
```

```{r Bind all data together, eval=FALSE}
artists_df <- read_csv("../1_data/Spotify/all_artists.csv")
albums_df <- read_csv("../1_data/Spotify/all_albums.csv")

tidy_tracks <- all_tracklists_with_features_nested %>%
  left_join(albums_df, by = "album_name") %>%
  left_join(artists_df, by = "artist_name")

write_csv(tidy_tracks, "../1_data/tidy_tracks.csv")
```

## Create edge weights
```{r Lengthen feature lists}
tidy_tracks <- read_csv("../1_data/tidy_tracks.csv")

tidy_tracks_long <- tidy_tracks %>%
  mutate(feature = str_split(feature, ",")) %>%
  unchop(feature)

all_tracklists_with_features_unnested <-
  all_tracklists %>%
  unnest(feature, keep_empty = TRUE)

write_csv(tidy_tracks_long, "../1_data/tidy_tracks_long.csv")
```

```{r Prep}
## Filter out entities with only 1 occurence
# Count occurences in artists vector
artist_count <- feats %>%
  group_by(artist) %>%
  summarise(artist_count = n()) 

# Count occurences in feature_list vector
feature_list_count <- feats %>%
  group_by(feature) %>%
  summarise(feature_list_count = n())
```

```{r}
## Filter out entities with only 1 occurence
# Count occurences in artists vector
artist_count <- feats %>%
  group_by(artist) %>%
  summarise(artist_count = n()) %>%
  rename(entity = artist) %>%
  ungroup()

# Count occurences in feature_list vector
feature_list_count <- feats %>%
  group_by(feature_list) %>%
  summarise(feature_list_count = n()) %>%
  rename(entity = feature_list) %>%
  ungroup()

# Aggregate occurences
entity_counts <- full_join(artist_count, 
                           feature_list_count,
                           by = "entity")

entity_counts <- entity_counts %>%
  rowwise() %>%
  mutate(total_counts = sum(artist_count,feature_list_count, na.rm = TRUE))

entity_counts <- entity_counts %>%
  select(entity, total_counts) %>%
  filter(total_counts >= 2)
```

```{r}
# Edge list, filtered
edge_list <- feats %>%
  filter(artist %in% entity_counts$entity | feature_list %in% entity_counts$entity) %>%
  select(artist, feature_list)

edge_list[sample(nrow(edge_list), 5), ]
``` 

```{r Create a nodes list}
# Isolate artists and features
artists <- edge_list %>%
  distinct(artist) %>% 
  rename(label = artist)

#artists <- artists[[1]]

features <- edge_list %>%
  distinct(feature_list) %>% 
  rename(label = feature_list)

#features <- features[[1]]

# Aggregate all entities
nodes <- full_join(artists,features) %>%
  rowid_to_column("id")

nodes[sample(nrow(nodes), 5), ]
```

```{r Add frequency weights to the edge list}
weighted_edge_list <- edge_list %>%
  group_by(artist,feature_list) %>%
  summarise(weight = n()) %>%
  ungroup()

weighted_edge_list[sample(nrow(weighted_edge_list), 5), ]
```

```{r Merge edge and node lists}
edges <- weighted_edge_list %>%
  rename(artist_chr = artist) %>%
  rename(featured_chr = feature_list)

edges <- edges %>% 
  left_join(nodes, by = c("artist_chr" = "label")) %>%
  rename(artist = id)

edges <- edges %>%
  left_join(nodes, by = c("featured_chr" = "label")) %>%
  rename(featured = id) 

edges <- edges %>%
  select(weight, artist, featured)

edges <- edges[c(2,3,1)]
```

# Network Analysis with `igraph`
```{r Create the igraph object}
routes_igraph <- graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)
routes_igraph
```

```{r Print edgelist from igraph object}
as_edgelist(routes_igraph, names=T)
```

```{r Print adjacency matrix}
as_adjacency_matrix(routes_igraph, attr="weight")
```

## Plot Entire Network Graph
```{r Initial network plot, eval=FALSE}
set.seed(489)
plot(routes_igraph, edge.arrow.size = 0.2, vertex.size = 5,vertex.label = NA)
```

```{r Plot with layout from Davidson-Harel algorithm}
set.seed(475)
routes_igraph_simple <- simplify(routes_igraph, remove.multiple = F, remove.loops = T) 
continuous_pal <- viridis(length(unique(degree(routes_igraph_simple))))
vertex_pal_degree <- continuous_pal[as.factor(as.numeric(degree(routes_igraph_simple)))]

l <- layout_with_dh(routes_igraph_simple)

pdf("../3_output/rap_feat_plot.pdf")
plot(routes_igraph_simple, layout = l, 
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25, 
     vertex.size = degree(routes_igraph_simple)/4, vertex.color = vertex_pal_degree,
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 1, vertex.label.color="black")
dev.off()
```

## Preliminary Community Detection
```{r  Naive community detection}
set.seed(475)

communities <- cluster_walktrap(routes_igraph_simple, weights = E(routes_igraph_simple)$weight, steps = 2,
  merges = TRUE, modularity = TRUE, membership = TRUE)

largest_comms <- which(table(communities$membership) >= 20)
largest_comms <- as.numeric(largest_comms)
# Remove the largest community
largest_comms <- largest_comms[-(which(largest_comms == 2))]

keep_comms <- V(routes_igraph_simple)[communities$membership %in% largest_comms]

routes_igraph_simple_small <- induced_subgraph(routes_igraph_simple, keep_comms)
communities_subset <- cluster_walktrap(routes_igraph_simple_small, weights = E(routes_igraph_simple_small)$weight, steps = 2,
  merges = TRUE, modularity = TRUE, membership = TRUE)

pdf(file="../3_output/rap_feat_plot_w_comms.pdf")
plot(communities_subset, routes_igraph_simple_small, layout = l, 
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = degree(routes_igraph_simple)/4, vertex.color = vertex_pal_degree,
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 1, vertex.label.color="black")
dev.off()
```

```{r Show just 1 community}
one_comm <- largest_comms[1]

keep_one_comm <- V(routes_igraph_simple)[communities$membership %in% one_comm]

routes_igraph_simple_onecomm <- induced_subgraph(routes_igraph_simple, keep_one_comm)
communities_subset_onecomm <- cluster_walktrap(routes_igraph_simple_onecomm, 
                                               weights = E(routes_igraph_simple_small)$weight, 
                                               steps = 2, merges = TRUE, modularity = TRUE, membership = TRUE)

pdf(file="../3_output/rap_feat_plot_one_comm.pdf")
plot(communities_subset_onecomm, routes_igraph_simple_onecomm, layout = l, 
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = degree(routes_igraph_simple)/4, vertex.color = vertex_pal_degree,
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 1, vertex.label.color="black")
dev.off()
```

## Ugly Plots

```{r Create the igraph object}
routes_igraph <- graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)
routes_igraph
```

```{r Plot a nicer looking graph}
set.seed(305)
routes_igraph_simple <- simplify(routes_igraph, remove.multiple = F, remove.loops = T) 
plot(routes_igraph_simple, 
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = 1,
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 3, vertex.label.color="black") 
```

```{r Plot with layout as random}
set.seed(397)
l <- layout.random(routes_igraph_simple)
plot(routes_igraph_simple, layout = l,
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = 1, 
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 3, vertex.label.color="black") 
```


```{r Plot with layout from graphopt algorithm}
set.seed(264)
l <- layout_with_graphopt(routes_igraph)
plot(routes_igraph_simple, layout = l,
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = 1, 
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 3, vertex.label.color="black")
```

```{r Plot with layout from Fruchterman-Reingold algorithm}
set.seed(761)
l <- layout_with_fr(routes_igraph)
plot(routes_igraph_simple, layout = l,
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = 1, 
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 3, vertex.label.color="black")
```

```{r Plot with layout from mutlidimensional scaling}
set.seed(678)
l <- layout_with_mds(routes_igraph)
plot(routes_igraph_simple, layout = l,
     edge.arrow.size = 0.2, edge.curved=.1, edge.width = 0.25,
     vertex.size = 1, 
     vertex.label = ifelse(degree(routes_igraph_simple) > 10, V(routes_igraph_simple)$label, NA),
     vertex.label.family="Helvetica", vertex.label.cex = 0.5, vertex.label.dist = 3, vertex.label.color="black")
```

# Reproducability
```{r}
print(sessionInfo())
```

